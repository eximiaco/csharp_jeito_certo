---
description: Regras e PadrÃµes do Projeto GymErp
globs:
alwaysApply: true
---

# Regras e PadrÃµes do Projeto GymErp

- **Regras validas apenas para projeto modernizado contido na pasta src**:
- **NUNCA** aplique essas regras para o projeto legado, dentro da pasta legacy

## ğŸ—ï¸ Arquitetura

### Vertical Slice Architecture
- **OrganizaÃ§Ã£o por features**: Cada funcionalidade Ã© organizada em sua prÃ³pria pasta com todos os arquivos relacionados
- **Estrutura padrÃ£o por feature**:
  ```
  Domain/[Contexto]/[Feature]/
  â”œâ”€â”€ Endpoint.cs      # FastEndpoints endpoint
  â”œâ”€â”€ Handler.cs       # Business logic handler
  â”œâ”€â”€ Request.cs       # Input model (record)
  â”œâ”€â”€ Response.cs      # Output model (opcional)
  â””â”€â”€ Command.cs       # Command model (quando aplicÃ¡vel)
  ```

### PadrÃ£o REPR (Request-Endpoint-Response-Pattern)
- **Endpoints** herdam de `Endpoint<TRequest, TResponse>`
- **Handlers** sÃ£o injetados diretamente nos endpoints via DI
- **Sem MediatR**: Chamadas diretas aos handlers para simplicidade

## ğŸ“š Bibliotecas e Frameworks

### Core Libraries
- **FastEndpoints**: Framework principal para APIs
- **CSharpFunctionalExtensions**: Para Result pattern e programaÃ§Ã£o funcional
- **Autofac**: Container de injeÃ§Ã£o de dependÃªncia
- **Entity Framework Core**: ORM com PostgreSQL
- **Dapper**: Queries SQL diretas quando necessÃ¡rio
- **WorkflowCore**: Para orquestraÃ§Ã£o de workflows
- **TestContainers**: Testes de integracao
- **Silverback**: Mensageria com Kafka

### Logging e Observabilidade
- **Serilog**: Logging estruturado
- **HealthChecks**: Monitoramento de saÃºde da aplicaÃ§Ã£o

### UtilitÃ¡rios
- **Flurl**: Cliente HTTP
- **Polly**: Resilience patterns
- **Dapper**: Queries SQL diretas quando necessÃ¡rio

## ğŸ¯ PadrÃµes de CÃ³digo

### Naming Conventions
- **Classes**: PascalCase (`Enrollment`, `Handler`, `Endpoint`)
- **MÃ©todos**: PascalCase (`HandleAsync`, `Create`)
- **Propriedades**: PascalCase (`Name`, `Email`)
- **VariÃ¡veis locais**: camelCase (`enrollmentResult`, `request`)
- **Constantes**: PascalCase (`MinimumSuspensionPeriod`)

### Estrutura de Classes

#### Endpoints
```csharp
public class Endpoint : Endpoint<Request, Response>
{
    private readonly Handler _handler;

    public Endpoint(Handler handler)
    {
        _handler = handler;
    }

    public override void Configure()
    {
        Post("/api/[resource]");
        AllowAnonymous(); // ou configuraÃ§Ã£o de auth

        // DocumentaÃ§Ã£o Swagger
        Summary(s => s
            .Summary("Breve descriÃ§Ã£o da operaÃ§Ã£o")
            .Description("DescriÃ§Ã£o detalhada do que o endpoint faz")
            .ExampleRequest(new Request { /* exemplo */ })
            .Response<Response>(200, "Sucesso")
            .Response(400, "Dados invÃ¡lidos")
            .Response(500, "Erro interno"));

        Tags("Nome do Contexto"); // Ex: "Subscriptions", "Financial"
    }

    public override async Task HandleAsync(Request req, CancellationToken ct)
    {
        var result = await _handler.HandleAsync(req);
        if (result.IsFailure)
        {
            await SendErrorsAsync(cancellation: ct);
            return;
        }
        await SendOkAsync(result.Value, ct);
    }
}
```

#### Handlers
```csharp
public class Handler(Dependencies... dependencies)
{
    public async Task<Result<TResponse>> HandleAsync(TRequest request)
    {
        // Business logic here
        // Use Result pattern for error handling
    }
}
```

#### Request/Response Models
```csharp
// Use records para immutability
public record Request
{
    public string Property { get; set; } = string.Empty;
    // Sempre inicializar strings com string.Empty
}

public record Response(Guid Id, string Name);
```

### Result Pattern
- **Sempre use Result<T>** para operaÃ§Ãµes que podem falhar
- **Result.Success(value)** para sucesso
- **Result.Failure(error)** para falhas
- **Verifique IsFailure** antes de acessar Value

### Dependency Injection
- **Primary constructors** para injeÃ§Ã£o de dependÃªncias
- **Registre no mÃ³dulo Autofac** correspondente
- **InstancePerLifetimeScope** para a maioria dos serviÃ§os

## ğŸ—‚ï¸ OrganizaÃ§Ã£o de Pastas

```
src/GymErp/
â”œâ”€â”€ Bootstrap/           # ConfiguraÃ§Ãµes de inicializaÃ§Ã£o
â”œâ”€â”€ Common/             # CÃ³digo compartilhado
â”œâ”€â”€ Domain/             # LÃ³gica de domÃ­nio
â”‚   â”œâ”€â”€ [Contexto]/     # Ex: Subscriptions, Financial, Scheduling
â”‚   â”‚   â”œâ”€â”€ [Feature]/  # Ex: AddNewEnrollment, SuspendEnrollment
â”‚   â”‚   â”œâ”€â”€ Aggregates/ # Entidades de domÃ­nio
â”‚   â”‚   â””â”€â”€ Infrastructure/ # DbContext, Repositories, Modules
â”œâ”€â”€ Tenant/             # Multi-tenancy
â””â”€â”€ Program.cs          # Entry point
```

## ğŸ”§ Comandos Ãšteis

### Build e Test
```bash
# Build do projeto
dotnet build

# Executar testes
dotnet test

# Executar aplicaÃ§Ã£o
dotnet run --project src/GymErp/GymErp.csproj

# Restore packages
dotnet restore
```

### Entity Framework
```bash
# Adicionar migration
dotnet ef migrations add [MigrationName] --project src/GymErp

# Atualizar banco
dotnet ef database update --project src/GymErp

# Remover Ãºltima migration
dotnet ef migrations remove --project src/GymErp
```

## ğŸ¨ Estilo de CÃ³digo

### FormataÃ§Ã£o
- **IndentaÃ§Ã£o**: 4 espaÃ§os
- **Chaves**: Nova linha (Allman style)
- **Using statements**: No topo do arquivo, ordenados
- **Nullable**: Habilitado (`<Nullable>enable</Nullable>`)

### Boas PrÃ¡ticas
- **Async/await**: Sempre use para operaÃ§Ãµes I/O
- **CancellationToken**: Passe para operaÃ§Ãµes async
- **ConfigureAwait(false)**: NÃ£o necessÃ¡rio em ASP.NET Core
- **Primary constructors**: Use quando apropriado
- **Records**: Para DTOs e value objects
- **Validation**: No domain model ou usando FluentValidation

### Error Handling
- **Result pattern** para business logic
- **Exceptions** apenas para casos excepcionais
- **Global exception handler** configurado no FastEndpoints

### DocumentaÃ§Ã£o Swagger
- **Sempre documente endpoints** com Summary e Description
- **Use Tags** para agrupar endpoints por contexto
- **ForneÃ§a exemplos** de request e response
- **Documente todos os cÃ³digos de status** possÃ­veis
- **Use nomes descritivos** e padronizados

#### Exemplo Completo de DocumentaÃ§Ã£o
```csharp
public override void Configure()
{
    Post("/api/enrollments");
    AllowAnonymous();

    Summary(s => s
        .Summary("Criar nova matrÃ­cula")
        .Description("Cria uma nova matrÃ­cula para um cliente no sistema")
        .ExampleRequest(new Request 
        { 
            Name = "JoÃ£o Silva",
            Email = "joao@email.com",
            Phone = "11999999999",
            Document = "12345678901",
            BirthDate = new DateTime(1990, 1, 1),
            Gender = "M",
            Address = "Rua das Flores, 123"
        })
        .Response<Guid>(201, "MatrÃ­cula criada com sucesso")
        .Response(400, "Dados de entrada invÃ¡lidos")
        .Response(409, "Cliente jÃ¡ possui matrÃ­cula ativa")
        .Response(500, "Erro interno do servidor"));

    Tags("Subscriptions");
}
```

#### PadrÃµes de Tags
- **Subscriptions**: MatrÃ­culas e assinaturas
- **Financial**: Pagamentos e cobranÃ§a
- **Scheduling**: Agendamentos e horÃ¡rios
- **Orchestration**: Workflows e processos

## ğŸ” SeguranÃ§a e ConfiguraÃ§Ã£o

### Authentication/Authorization
- Configure no mÃ©todo `Configure()` do endpoint
- Use `AllowAnonymous()` para endpoints pÃºblicos
- Implemente polÃ­ticas de autorizaÃ§Ã£o quando necessÃ¡rio

### Configuration
- **appsettings.json** para configuraÃ§Ãµes base
- **User Secrets** para desenvolvimento
- **Environment Variables** para produÃ§Ã£o
- **Options pattern** para configuraÃ§Ãµes tipadas

## ğŸ“Š Monitoramento

### Health Checks
- Endpoint `/healthz` configurado
- Adicione checks customizados conforme necessÃ¡rio

### Logging
- **Serilog** configurado com enrichers
- **Structured logging** sempre que possÃ­vel
- **Log levels** apropriados (Information, Warning, Error)

## ğŸš€ Deploy e CI/CD

### Docker
- Dockerfile otimizado para .NET 9
- Multi-stage build para reduzir tamanho da imagem

### Environment
- **Development**: Local com User Secrets
- **Staging/Production**: Environment Variables
- **Database**: PostgreSQL com connection string configurÃ¡vel

---

## ğŸ“ Notas Importantes

1. **NÃ£o use MediatR** - Chamadas diretas aos handlers
2. **Prefira composition over inheritance**
3. **Mantenha handlers simples e focados**
4. **Use aggregates para encapsular business rules**
5. **Repository pattern** apenas quando necessÃ¡rio
6. **Unit of Work** para transaÃ§Ãµes
7. **Workflows** para processos complexos multi-step
8. **Testes de integraÃ§Ã£o** - com TestContainers
9. **Mensageria** - com Kafka atraves da biblioteca Silverback